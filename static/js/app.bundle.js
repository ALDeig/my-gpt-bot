(()=>{"use strict";function e(e,t){const n=document.createElement("div"),o=document.querySelector(".chat-container");n.className="message "+t,n.insertAdjacentHTML("afterbegin",e),o.appendChild(n),n.querySelectorAll(".highlight").forEach((e=>{e&&function(e){const t=document.createElement("button");t.className="copy-btn",t.textContent="Копировать",e.prepend(t)}(e)})),function(){const e=document.querySelectorAll(".copy-btn");0!==e.length&&e.forEach((e=>{e.addEventListener("click",(()=>{const t=e.nextElementSibling.innerText;navigator.clipboard.writeText(t).then((()=>{e.textContent="Скопировано!",setTimeout((()=>{e.textContent="Копировать"}),2e3)})).catch((e=>{console.error("Ошибка копирования: ",e)}))}))}))}(),o.scrollTop=o.scrollHeight}const t={};function n(n){let o=t[n];return o&&o.readyState===WebSocket.OPEN||(o&&o.close(),o=new WebSocket(`wss://${window.location.host}/communicate/${n}`),o.onopen=()=>{console.log(`Connected to WebSocket server for chat ${n}`)},o.onclose=e=>{console.log(`Disconnected from WebSocket server for chat ${n}. Reason: ${e.reason}`),delete t[n]},o.onerror=e=>{console.error("WebSocket error:",e)},o.onmessage=t=>{e(JSON.parse(t.data).text,"bot-message")},t[n]=o),o}function o(){const t=document.querySelector("textarea"),n=sessionStorage.getItem("currentChatId"),o=t.value.trim(),c=getOrCreateSocket(n);o&&(e(o,"user-message"),c.send(JSON.stringify({type:"message",text:o})),t.value="",t.style.height="auto")}function c(t,o){const c=document.createElement("div");c.className="chat-item",c.id=o.id,c.innerHTML=`\n        <span>${o.id}. ${o.model}</span>\n        <button class="delete-chat-btn" id="${o.id}">\n            <svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="16" width="16">\n                <path d="M3 6h18"></path>\n                <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>\n                <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>\n            </svg>\n        </button>\n    `,t.appendChild(c),c.querySelector(".delete-chat-btn").addEventListener("click",(async function(e){e.stopPropagation(),c.remove(),await async function(e){const t=await fetch(`/chats/${e}`,{method:"DELETE"});return await t.json()}(o.id)})),c.addEventListener("click",(async function(){await async function(t){const o=document.querySelector(".sidebar"),c=await fetch(`/chats/${t}`),s=await c.json();n(s.id);const r=document.querySelector(".chat-container");document.querySelector("#currentModel").textContent=`${s.id}. ${s.model}`,r.innerHTML="",s.messages.forEach((t=>e(t.content,"assistant"==t.role?"bot-message":"user-message"))),a(s.id),o.classList.toggle("active")}(o.id)}))}function a(e){sessionStorage.setItem("currentChatId",e);const t=document.querySelector("textarea"),n=document.querySelector(".send-btn");t.disabled=!1,n.disabled=!1}document.addEventListener("DOMContentLoaded",(async function(){const e=window.Telegram.WebApp;let t;t=e.initDataUnsafe.user?e.initDataUnsafe.user.id:new URL(window.location.href).searchParams.get("user_id"),e.expand(),await async function(e){const t=await async function(e){const t=await fetch(`/chats?user_id=${e}`);return await t.json()}(e);!async function(e){const t=document.querySelector(".chat-list");e.forEach((e=>c(t,e)))}(t)}(t),function(e){const t=document.querySelector(".hamburger"),s=document.querySelector(".sidebar"),r=document.querySelector(".new-chat-btn"),i=document.querySelector(".modal-overlay"),d=document.querySelector("#cancelModelSelection"),l=document.querySelector("#confirmModelSelection"),u=document.querySelector("textarea"),m=document.querySelector(".send-btn");t.addEventListener("click",(function(){s.classList.toggle("active")})),document.addEventListener("click",(function(e){s.contains(e.target)||t.contains(e.target)||s.classList.remove("active")})),r.addEventListener("click",(async()=>{await async function(e){e.style.display="flex";const t=document.querySelector(".model-options");t.innerHTML="",sessionStorage.setItem("selectedModel",null),function(e,t){t.forEach((t=>{const n=document.createElement("div");n.className="model-option",n.setAttribute("data-model-id",t.id),n.innerHTML=`\n        <h3>${t.model}</h3>\n        <p>${t.description}</p>\n    `,e.appendChild(n)}))}(t,await async function(){const e=await fetch("/ai_models");return await e.json()}()),document.querySelectorAll(".model-option").forEach((e=>{e.addEventListener("click",(e=>function(e){document.querySelectorAll(".model-option").forEach((e=>e.classList.remove("selected"))),e.currentTarget.classList.add("selected"),sessionStorage.setItem("selectedModel",e.currentTarget.dataset.modelId)}(e)))}))}(i)})),d.addEventListener("click",(function(){i.style.display="none"})),l.addEventListener("click",(async function(){await async function(e){const t=await async function(e){const t={modelId:sessionStorage.getItem("selectedModel"),userId:e};console.log(t);const n=await fetch("/new_chat",{method:"POST",headers:{"Content-Type":"application/json;charset=utf-8"},body:JSON.stringify(t)});return await n.json()}(e),o=document.querySelector(".modal-overlay"),s=document.querySelector("#currentModel"),r=document.querySelector(".chat-container"),i=document.querySelector(".chat-list");a(t.id),n(t.id),c(i,t),s.textContent=`${t.id}. ${t.model}`,r.innerHTML="",o.style.display="none"}(e)})),u.addEventListener("input",(function(){this.style.height="auto",this.style.height=Math.min(this.scrollHeight,200)+"px"})),u.addEventListener("keydown",(function(e){"Enter"!==e.key||e.shiftKey||(e.preventDefault(),o())})),m.addEventListener("click",o)}(t)}))})();