(()=>{"use strict";function e(e,t){const n=document.createElement("div"),o=document.querySelector(".chat-container");n.className="message "+t,n.insertAdjacentHTML("afterbegin",e),o.appendChild(n),n.querySelectorAll(".codehilite").forEach((e=>{e&&function(e){const t=document.createElement("button");t.className="copy-btn",t.textContent="Копировать",e.prepend(t)}(e)})),function(){const e=document.querySelectorAll(".copy-btn");0!==e.length&&e.forEach((e=>{e.addEventListener("click",(()=>{const t=e.nextElementSibling.querySelector("code").innerText;navigator.clipboard.writeText(t).then((()=>{e.textContent="Скопировано!",setTimeout((()=>{e.textContent="Копировать"}),2e3)})).catch((e=>{console.error("Ошибка копирования: ",e)}))}))}))}(),o.scrollTop=o.scrollHeight}const t={};function n(e){if(e in t)return;const n=new WebSocket("wss://aldeig.duckdns.org/app/communicate/"+e);!function(e,n){t[e]=n}(e,n),n.onopen=function(){console.log("Connected to WebSocket server")},n.onmessage=c,n.onclose=function(){console.log("Disconnected from WebSocket server")},n.onerror=function(e){console.error("WebSocket error:",e)}}function o(){const n=document.querySelector("textarea"),o=sessionStorage.getItem("currentChatId"),c=n.value.trim(),a=t[o];c&&(e(c,"user-message"),a.send(JSON.stringify({type:"message",text:c})),n.value="",n.style.height="auto"),console.log()}function c(t){console.log("Received message:",t.data),e(JSON.parse(t.data).text,"bot-message")}function a(t,o){const c=document.createElement("div");c.className="chat-item",c.id=o.id,c.innerHTML=`\n        <span>${o.id}. ${o.model}</span>\n        <button class="delete-chat-btn" id="${o.id}">\n            <svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="16" width="16">\n                <path d="M3 6h18"></path>\n                <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>\n                <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>\n            </svg>\n        </button>\n    `,t.appendChild(c),c.querySelector(".delete-chat-btn").addEventListener("click",(async function(e){e.stopPropagation(),c.remove(),await async function(e){const t=await fetch(`/app/chats/${e}`,{method:"DELETE"});return await t.json()}(o.id)})),c.addEventListener("click",(async function(){await async function(t){const o=await fetch(`/app/chats/${t}`),c=await o.json();n(c.id);const a=document.querySelector(".chat-container");document.querySelector("#currentModel").textContent=`${c.id}. ${c.model}`,a.innerHTML="",c.messages.forEach((t=>e(t.content,"assistant"==t.role?"bot-message":"user-message"))),s(c.id)}(o.id)}))}function s(e){sessionStorage.setItem("currentChatId",e);const t=document.querySelector("textarea"),n=document.querySelector(".send-btn");t.disabled=!1,n.disabled=!1}const i=window.Telegram.WebApp;document.addEventListener("DOMContentLoaded",(async function(){i.expand(),await async function(e){!async function(e){const t=document.querySelector(".chat-list");e.forEach((e=>a(t,e)))}(await async function(e){const t=await fetch(`/app/chats?user_id=${e}`);return await t.json()}(e.initDataUnsafe.user.id))}(i),function(){const e=document.querySelector(".hamburger"),t=document.querySelector(".sidebar"),c=document.querySelector(".new-chat-btn"),r=document.querySelector(".modal-overlay"),d=document.querySelector("#cancelModelSelection"),l=document.querySelector("#confirmModelSelection"),u=document.querySelector("textarea"),m=document.querySelector(".send-btn");e.addEventListener("click",(function(){t.classList.toggle("active")})),document.addEventListener("click",(function(n){t.contains(n.target)||e.contains(n.target)||t.classList.remove("active")})),c.addEventListener("click",(async()=>{await async function(e){e.style.display="flex";const t=document.querySelector(".model-options");t.innerHTML="",sessionStorage.setItem("selectedModel",null),function(e,t){t.forEach((t=>{const n=document.createElement("div");n.className="model-option",n.setAttribute("data-model-id",t.id),n.innerHTML=`\n        <h3>${t.model}</h3>\n        <p>${t.description}</p>\n    `,e.appendChild(n)}))}(t,await async function(){const e=await fetch("/app/ai_models");return await e.json()}()),document.querySelectorAll(".model-option").forEach((e=>{e.addEventListener("click",(e=>function(e){document.querySelectorAll(".model-option").forEach((e=>e.classList.remove("selected"))),e.currentTarget.classList.add("selected"),sessionStorage.setItem("selectedModel",e.currentTarget.dataset.modelId)}(e)))}))}(r)})),d.addEventListener("click",(function(){r.style.display="none"})),l.addEventListener("click",(async function(){await async function(e){const t=await async function(e){const t={modelId:sessionStorage.getItem("selectedModel"),userId:e};console.log(t);const n=await fetch("/app/new_chat",{method:"POST",headers:{"Content-Type":"application/json;charset=utf-8"},body:JSON.stringify(t)});return await n.json()}(e),o=document.querySelector(".modal-overlay"),c=document.querySelector("#currentModel"),i=document.querySelector(".chat-container"),r=document.querySelector(".chat-list");s(t.id),n(t.id),a(r,t),c.textContent=`${t.id}. ${t.model}`,i.innerHTML="",o.style.display="none"}(i.initDataUnsafe.user.id)})),u.addEventListener("input",(function(){this.style.height="auto",this.style.height=Math.min(this.scrollHeight,200)+"px"})),u.addEventListener("keydown",(function(e){"Enter"!==e.key||e.shiftKey||(e.preventDefault(),o())})),m.addEventListener("click",o)}()}))})();